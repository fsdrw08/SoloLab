
### Sync day0 related container images to zot vyos container registry
[LocalWorkShop/Sync-OCIImage/](../../LocalWorkShop/Sync-OCIImage/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="LocalWorkShop/Sync-OCIImage"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
$proxy="127.0.0.1:7890"; $env:HTTP_PROXY=$proxy; $env:HTTPS_PROXY=$proxy; $env:NO_PROXY="sololab"
.\Sync-OCIImage.ps1 -SyncProfile "Day0.jsonc"  -PrivateRegistry "zot.vyos.sololab.dev" # -Upload $false
# .\Sync-OCIImage.ps1 -SyncProfile "Day0.jsonc" -LocalStore "D:/Users/Public/Downloads/containers" -PrivateRegistry "zot.vyos.sololab.dev"
```

### Create Day0-FCOS VM
[TerraformWorkShop/Hyper-V/VM-Day0-FCOS](../../TerraformWorkShop/Hyper-V/VM-Day0-FCOS/)
1. Download FCOS Hyper-V image
[Download Fedora CoreOS](https://fedoraproject.org/coreos/download?stream=stable)

2. Create image dir
```powershell
$ImageDir="C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\Images\fcos"
if (-not (Test-Path $ImageDir)) {
    New-Item -Path $ImageDir -ItemType "Directory"
}
```

3. Extra the vhd file to `C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\Images\fcos`

4. Rename the vhd to `fedora-coreos-hyperv.x86_64.vhdx` in `C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\Images\fcos`

5. Resize the vhdx file to 30GB
```powershell
$vhdxPath="C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\Images\fcos\fedora-coreos-hyperv.x86_64.vhdx"
Resize-VHD -Path $vhdxPath -SizeBytes 32212254720
```
5. Run terraform
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Hyper-V/VM-Day0-FCOS"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
sudo terraform init
terraform apply --auto-approve
```
For the reason the the ignition process can only run before VM first boot up, 
we have to turn on the VM manually.

### Prepare helm dependency
[HelmWorkShop/helm-charts/charts](../../HelmWorkShop/helm-charts/charts)
```powershell
$originalDir=Get-Location | Select-Object -ExpandProperty path
$repoDir=git rev-parse --show-toplevel
$childPath="HelmWorkShop/helm-charts/charts"
$proxy="127.0.0.1:7890"; $env:HTTP_PROXY=$proxy; $env:HTTPS_PROXY=$proxy; $env:NO_PROXY="sololab"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
Get-ChildItem | ForEach-Object {
  Set-Location $_.fullname
  helm dependency update
}
Set-Location -Path $originalDir
```

### Deploy etcd server in Day0 VM
[TerraformWorkShop/Quadlet/etcd/](../../TerraformWorkShop/Quadlet/etcd/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/etcd"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Deploy CoreDNS server in Day0 VM
[TerraformWorkShop/Quadlet/coredns](../../TerraformWorkShop/Quadlet/coredns)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/coredns"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Deploy Traefik proxy in Day0 VM
[TerraformWorkShop/Quadlet/traefik-day0](../../TerraformWorkShop/Quadlet/traefik-day0)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/traefik-day0"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Seed DNS record to etcd
[TerraformWorkShop/etcd/skydns](../../TerraformWorkShop/etcd/skydns)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/etcd/skydns"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Deploy LLDAP server in Day0 VM
[TerraformWorkShop/Quadlet/lldap](../../TerraformWorkShop/Quadlet/lldap)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/lldap"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Seed LDAP data in LLDAP
[TerraformWorkShop/LDAP/lldap/](../../TerraformWorkShop/LDAP/lldap/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/LDAP/lldap"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Deploy zot image registry in Day0 VM
[TerraformWorkShop/Quadlet/zot/](../../TerraformWorkShop/Quadlet/zot/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/zot"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Sync day0 related container images to day0 zot image registry
[LocalWorkShop/Sync-OCIImage/Sync-OCIImage.ps1](../../LocalWorkShop/Sync-OCIImage/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="LocalWorkShop/Sync-OCIImage"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
$proxy="127.0.0.1:7890"; $env:HTTP_PROXY=$proxy; $env:HTTPS_PROXY=$proxy; $env:NO_PROXY="sololab"
.\Sync-OCIImage.ps1 -PrivateRegistry "zot.day0.sololab" -SyncProfile "Day0.jsonc" # -Upload $false
# .\Sync-OCIImage.ps1 -PrivateRegistry "zot.day0.sololab" -SyncProfile "Day0.jsonc" -LocalStore "D:/Users/Public/Downloads/containers" -Upload $false
```

### Sync trivy-db to zot
[LocalWorkShop/Sync-OCIImage/](../../LocalWorkShop/Sync-OCIImage/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="LocalWorkShop/Sync-OCIImage"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
$proxy="127.0.0.1:7890"; $env:HTTP_PROXY=$proxy; $env:HTTPS_PROXY=$proxy; $env:NO_PROXY="sololab"
.\Sync-TrivyDB.ps1 -PrivateRegistry "zot.day0.sololab" -SyncProfile "Day0-Trivy.jsonc" -Download $false
# .\Sync-TrivyDB.ps1 -PrivateRegistry "zot.day0.sololab" -SyncProfile "Day0-Trivy.jsonc" -LocalStore "D:/Users/Public/Downloads/containers/trivy"
```

<!-- 
### Deploy dex IdP in Day0 VM
[TerraformWorkShop/Quadlet/dex/](../../TerraformWorkShop/Quadlet/dex/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/dex"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 8. Deploy keycloak IdP in Day0 VM
[TerraformWorkShop/Quadlet/keycloak/](../../TerraformWorkShop/Quadlet/keycloak/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/keycloak"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 8. Deploy zitadel IdP in Day0 VM
[TerraformWorkShop/Quadlet/zitadel/](../../TerraformWorkShop/Quadlet/zitadel/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/zitadel"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

After deploy success, copy machine jwt token into [TerraformWorkShop/zitadel/](../../TerraformWorkShop/zitadel/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Zitadel"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
scp Day0-FCOS:/var/home/podmgr/.local/share/containers/storage/volumes/zitadel-backend-pvc/_data/zitadel-admin-sa.json .
```

### 9. Set LDAP provider in Zitadel
[TerraformWorkShop/Zitadel/Day0](../../TerraformWorkShop/Zitadel/Day0)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Zitadel/Day0"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```  

### Deploy PostgreSQL database in Day0 VM
[TerraformWorkShop/Quadlet/postgresql-infra](../../TerraformWorkShop/Quadlet/postgresql-infra)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/postgresql-infra"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
``` -->


### Deploy Cockpit web console in Day0 VM
[TerraformWorkShop/Quadlet/cockpit](../../TerraformWorkShop/Quadlet/cockpit)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/cockpit"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
``` 


<!-- 
### 12. Deploy sftpgo in Day0 VM
[TerraformWorkShop/Quadlet/sftpgo](../../TerraformWorkShop/Quadlet/sftpgo/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/sftpgo"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 13. Config groups in sftpgo 
[TerraformWorkShop/SFTPGo](../../TerraformWorkShop/SFTPGo/Management)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/SFTPGo/Management"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 14. Upload files to sftpgo
- Sync binary files to sftpgo [LocalWorkShop/SyncTo-SFTPGo/SyncTo-SFTPGo.ps1](../../LocalWorkShop/SyncTo-SFTPGo/SyncTo-SFTPGo.ps1)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="LocalWorkShop/SyncTo-SFTPGo"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
.\SyncTo-SFTPGo.ps1 -SyncProfile "Day2.jsonc" # -Upload $false
# .\Sync-SFTPGo.ps1 -SyncProfile "Day0.jsonc" -LocalStore "D:/Users/Public/Downloads/bin" -Upload $false
``` 
-->

### Deploy dufs in Day0 VM
[TerraformWorkShop/Quadlet/dufs](../../TerraformWorkShop/Quadlet/dufs/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/dufs"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Upload files to dufs
- Sync files to dufs [LocalWorkShop/SyncTo-Dufs/SyncTo-Dufs.ps1](../../LocalWorkShop/SyncTo-Dufs/SyncTo-Dufs.ps1)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="LocalWorkShop/SyncTo-Dufs"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
$proxy="127.0.0.1:7890"; $env:HTTP_PROXY=$proxy; $env:HTTPS_PROXY=$proxy; $env:NO_PROXY="sololab"
.\SyncTo-Dufs.ps1 -SyncProfile "Day1.jsonc" # -Upload $false
# .\SyncTo-Dufs.ps1 -SyncProfile "Day1.jsonc" -LocalStore "D:/Users/Public/Downloads/bin" -Upload $false
``` 
<!-- - Create dir `certs` in dufs: 
  - upload [TerraformWorkShop/TLS/RootCA/root.crt](../../TerraformWorkShop/TLS/RootCA/root.crt) (which create in [0.Preparation.md](0.Preparation.md)) to dufs certs dir  -->

### Deploy Prometheus-Podman-Exporter in Day0 VM
[TerraformWorkShop/Quadlet/exporters-day0](../../TerraformWorkShop/Quadlet/exporters-day0/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/exporters-day0"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Deploy Vault server to Day0 VM
[TerraformWorkShop/Quadlet/vault](../../TerraformWorkShop/Quadlet/vault/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/vault"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Config KVV2 secret backend in Vault
[TerraformWorkShop/Vault/Secrets/KV-V2](../../TerraformWorkShop/Vault/Secrets/KV-V2/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Vault/Secrets/KV-V2"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Config LDAP login and sync LDAP user/group to Vault
[TerraformWorkShop/Vault/Auth/LDAP](../../TerraformWorkShop/Vault/Auth/LDAP/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Vault/Auth/LDAP"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Config ACL policy in Vault
[TerraformWorkShop/Vault/policy](../../TerraformWorkShop/Vault/policy/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Vault/policy"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Config Vault as OIDC provider
[TerraformWorkShop/Vault/Identity/OIDC](../../TerraformWorkShop/Vault/Identity/OIDC/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Vault/Identity/OIDC"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
# You might need to run `terraform apply` twice
```


### Deploy MinIO in Day0 VM
[TerraformWorkShop/Quadlet/minio](../../TerraformWorkShop/Quadlet/minio/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/minio"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```


### Config Minio ACL and bucket in Day0 MinIO
[TerraformWorkShop/MinIO/IAM](../../TerraformWorkShop/MinIO/IAM/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/MinIO/IAM"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Deploy nfs-ganesha in Day0 VM
[TerraformWorkShop/Quadlet/exporters-day0](../../TerraformWorkShop/Quadlet/nfs-ganesha/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/nfs-ganesha"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```