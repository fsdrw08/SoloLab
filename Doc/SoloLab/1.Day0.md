### 1. Provision VyOS VM image by packer
[PackerWorkShop/VyOS](../../PackerWorkShop/VyOS)

### 2. Prepare Terraform Plugins
[TerraformWorkShop](../../TerraformWorkShop/README.md)

### 3. Create and trust private root CA
[TerraformWorkShop/TLS/RootCA](../../TerraformWorkShop/TLS/RootCA/)
run:
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/TLS/RootCA"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```
After provisioned resources in this dir, install the root.crt to trust ca dir.

### 4. Create Hyper-V Internal Switch
[TerraformWorkShop/Hyper-V/Switch-Internal](../../TerraformWorkShop/Hyper-V/Switch-Internal/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Hyper-V/Switch-Internal"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### Prepare ssh config
Copy dir [LocalWorkShop/.ssh](../../LocalWorkShop/.ssh/) to user home dir

### 5. Create data disks
[TerraformWorkShop/Hyper-V/Disks-Data](../../TerraformWorkShop/Hyper-V/Disks-Data/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Hyper-V/Disks-Data"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 6. Create VyOS VM
[TerraformWorkShop/Hyper-V/VM-VyOS](../../TerraformWorkShop/Hyper-V/VM-VyOS/)
Then config shellcrash if need [TerraformWorkShop\Hyper-V\VM-VyOS\shellclash\README.md](../../TerraformWorkShop/Hyper-V/VM-VyOS/shellclash/README.md)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Hyper-V/VM-VyOS"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 7. Create Day0-FCOS VM
[TerraformWorkShop/Hyper-V/VM-Day0-FCOS](../../TerraformWorkShop/Hyper-V/VM-Day0-FCOS/)
1. Download FCOS Hyper-V image
[Download Fedora CoreOS](https://fedoraproject.org/coreos/download?stream=stable)

2. Create image dir
```powershell
$ImageDir="C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\Images\fcos"
if (-not (Test-Path $ImageDir)) {
    New-Item -Path $ImageDir -ItemType "Directory"
}
```

3. Extra the vhd file to `C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\Images\fcos`

4. Rename the vhd to `fedora-coreos-hyperv.x86_64.vhdx` in `C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\Images\fcos`

##### Prepare kvpctl tool
1. Download kvpctl.exe from https://github.com/containers/libhvee/releases

2. Extra exe file to C:\Windows

##### Run terraform
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Hyper-V/VM-Day0-FCOS"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
sudo terraform init
terraform apply --auto-approve
```
For the reason the the ignition process can only run before VM first boot up, 
we have to turn on the VM manually.

### 8. Deploy zot image registry in Day0 VM
[TerraformWorkShop/Quadlet/zot/](../../TerraformWorkShop/Quadlet/zot/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/zot"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 9. Sync container image to zot
[LocalWorkShop/Sync-OCIImage/Sync-OCIImage.ps1](../../LocalWorkShop/Sync-OCIImage/Sync-OCIImage.ps1)

### 10. Sync trivy-db to zot
[LocalWorkShop/Sync-OCIImage/Sync-TrivyDB.ps1](../../LocalWorkShop/Sync-OCIImage/Sync-TrivyDB.ps1)

### 11. Deploy etcd server in Day0 VM
[TerraformWorkShop/Quadlet/etcd/](../../TerraformWorkShop/Quadlet/etcd/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/etcd"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 12. Deploy CoreDNS server in Day0 VM
[TerraformWorkShop/Quadlet/coredns](../../TerraformWorkShop/Quadlet/coredns)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/coredns"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 13. Deploy PowerDNS server in VyOS
[TerraformWorkShop/VyOS/Container-PowerDNS/](../../TerraformWorkShop/VyOS/Container-PDNS-Auth/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/VyOS/Container-PDNS-Auth"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 14. Seed DNS record to PowerDNS
[TerraformWorkShop/PowerDNS/zones](../../TerraformWorkShop/PowerDNS/zones)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/PowerDNS/zones"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 15. Config haproxy in VyOS
[TerraformWorkShop/VyOS/HAProxy](../../TerraformWorkShop/VyOS/HAProxy/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/VyOS/HAProxy"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 13. Deploy PostgreSQL database in Day0 VM
[TerraformWorkShop/Quadlet/postgresql-infra](../../TerraformWorkShop/Quadlet/postgresql-infra)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/postgresql-infra"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 14. Seed DNS record to etcd
[TerraformWorkShop/etcd/skydns](../../TerraformWorkShop/etcd/skydns)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/etcd/skydns"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 15. Deploy Traefik proxy in Day0 VM
[TerraformWorkShop/Quadlet/traefik-day0](../../TerraformWorkShop/Quadlet/traefik-day0)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/traefik-day0"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 16. Deploy Cockpit web console in Day0 VM
[TerraformWorkShop/Quadlet/cockpit](../../TerraformWorkShop/Quadlet/cockpit)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/cockpit"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 17. Deploy LLDAP server in Day0 VM
[TerraformWorkShop/Quadlet/lldap](../../TerraformWorkShop/Quadlet/lldap)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/lldap"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 18. Seed LDAP data in LLDAP
[TerraformWorkShop/LDAP/lldap/](../../TerraformWorkShop/LDAP/lldap/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/LDAP/lldap"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 19. Deploy dufs in Day0 VM
[TerraformWorkShop/Quadlet/dufs](../../TerraformWorkShop/Quadlet/dufs/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/dufs"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 20. Upload files to dufs
- Sync binary files to dufs [LocalWorkShop/SyncTo-Dufs/SyncTo-Dufs.ps1](../../LocalWorkShop/SyncTo-Dufs/SyncTo-Dufs.ps1)
- Create dir `certs` in dufs: 
  - upload [TerraformWorkShop/TLS/RootCA/root.crt](../../TerraformWorkShop/TLS/RootCA/root.crt) (which create in [0.Preparation.md](0.Preparation.md)) to dufs certs dir

### 21. Deploy Prometheus-Podman-Exporter in Day0 VM
[TerraformWorkShop/Quadlet/exporters-day0](../../TerraformWorkShop/Quadlet/exporters-day0/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/exporters-day0"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```

### 22. Deploy nfs-ganesha in Day0 VM
[TerraformWorkShop/Quadlet/exporters-day0](../../TerraformWorkShop/Quadlet/nfs-ganesha/)
```powershell
$repoDir=git rev-parse --show-toplevel
$childPath="TerraformWorkShop/Quadlet/nfs-ganesha"
Set-Location -Path (Join-Path -Path $repoDir -ChildPath $childPath)
# terraform init; terraform apply ...
```