# yaml-language-server: $schema=https://raw.githubusercontent.com/Relativ-IT/Butane-Schemas/Release/Butane-Schema.json
variant: fcos
version: 1.5.0
# config users
passwd:
  users:
    # set rootless user password and ssh key
    - name: podmgr
      uid: 1001
      # to gen password hash
      # https://docs.fedoraproject.org/en-US/fedora-coreos/authentication/#_using_password_authentication
      password_hash: ${password_hash_1001}
      ssh_authorized_keys:
        - "${ssh_authorized_keys_1001}"
storage:
  files:
    # enable lingering to make user level service able to auto start on boot
    - path: /var/lib/systemd/linger/podmgr
    # source bash auto completion
    - path: /var/home/podmgr/.bashrc
      overwrite: true
      user:
        id: 1001
      group:
        id: 1001
      contents:
        inline: |
          source /etc/profile.d/bash_completion.sh
  directories:
    - path: /var/home/podmgr
      mode: 0700
      user:
        id: 1001
      group:
        id: 1001
    - path: /var/home/podmgr/.local
      mode: 0700
      user:
        id: 1001
      group:
        id: 1001
    - path: /var/home/podmgr/.config
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # config podman quadlet
    # https://www.redhat.com/sysadmin/multi-container-application-podman-quadlet
    - path: /var/home/podmgr/.config/containers
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    - path: /var/home/podmgr/.config/containers/systemd
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # config user level systemd
    - path: /var/home/podmgr/.config/systemd
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    - path: /var/home/podmgr/.config/systemd/user
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # create user level default.target.wants dir for service auto start
    # https://docs.fedoraproject.org/en-US/fedora-coreos/tutorial-user-systemd-unit-on-boot/
    - path: /var/home/podmgr/.config/systemd/user/default.target.wants
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # create user level sockets.target.wants dir for service auto run during this phase
    # then link the socket in this dir for socket auto start when user login
    # https://github.com/coreos/fedora-coreos-pipeline/blob/0a519b24de4e779a3e44eaaf1784993a3468b9b6/multi-arch-builders/builder-common.bu#L113
    - path: /var/home/podmgr/.config/systemd/user/sockets.target.wants
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # create user level halt.target.wants dir for service auto run during this phase
    - path: /var/home/podmgr/.config/systemd/user/halt.target.wants
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # create user level poweroff.target.wants dir for service auto run during this phase
    - path: /var/home/podmgr/.config/systemd/user/poweroff.target.wants
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # create user level shutdown.target.wants dir for service auto run during this phase
    - path: /var/home/podmgr/.config/systemd/user/shutdown.target.wants
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
    # create user level reboot.target.wants dir for service auto run during this phase
    - path: /var/home/podmgr/.config/systemd/user/reboot.target.wants
      mode: 0755
      user:
        id: 1001
      group:
        id: 1001
  links:
    # link the socket in this dir for socket auto start when user login
    - path: /var/home/podmgr/.config/systemd/user/sockets.target.wants/podman.socket
      target: /usr/lib/systemd/user/podman.socket
      overwrite: true
      user:
        id: 1001
      group:
        id: 1001
